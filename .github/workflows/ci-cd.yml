name: 智慧社区平台 CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 使用Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: 安装依赖
      run: |
        npm install
        npm --prefix ./frontend-admin install
    
    - name: 运行Lint检查
      run: |
        npm run lint
        npm --prefix ./frontend-admin run lint
    
    - name: 运行测试
      run: npm test
    
    - name: 构建项目
      run: |
        npm run build
        npm --prefix ./frontend-admin run build
    
    - name: 缓存构建结果
      uses: actions/cache@v3
      with:
        path: |
          ./dist
          ./frontend-admin/dist
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-
  
  deploy:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 恢复缓存的构建结果
      uses: actions/cache@v3
      with:
        path: |
          ./dist
          ./frontend-admin/dist
        key: ${{ runner.os }}-build-${{ github.sha }}
    
    - name: 配置SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: 添加服务器到已知主机
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
    
    - name: 部署到服务器
      run: |
        # 部署后端
        rsync -avz --delete ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/var/www/smart-community/api/
        
        # 部署前端管理后台
        rsync -avz --delete ./frontend-admin/dist/ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/var/www/smart-community/admin/
        
        # 执行远程部署脚本
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} 'cd /var/www/smart-community && ./deploy.sh'
    
    - name: 发送部署通知
      uses: joelwmale/webhook-action@master
      with:
        url: ${{ secrets.WEBHOOK_URL }}
        body: '{"text": "🚀 智慧社区平台已成功部署！\n\n提交者: ${{ github.actor }}\n提交信息: ${{ github.event.commits[0].message }}\n查看详情: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}' 