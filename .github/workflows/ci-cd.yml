name: æ™ºæ…§ç¤¾åŒºå¹³å° CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: ä½¿ç”¨Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        npm install
        npm --prefix ./frontend-admin install
    
    - name: è¿è¡ŒLintæ£€æŸ¥
      run: |
        npm run lint
        npm --prefix ./frontend-admin run lint
    
    - name: è¿è¡Œæµ‹è¯•
      run: npm test
    
    - name: æ„å»ºé¡¹ç›®
      run: |
        npm run build
        npm --prefix ./frontend-admin run build
    
    - name: ç¼“å­˜æ„å»ºç»“æœ
      uses: actions/cache@v3
      with:
        path: |
          ./dist
          ./frontend-admin/dist
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-
  
  deploy:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: æ¢å¤ç¼“å­˜çš„æ„å»ºç»“æœ
      uses: actions/cache@v3
      with:
        path: |
          ./dist
          ./frontend-admin/dist
        key: ${{ runner.os }}-build-${{ github.sha }}
    
    - name: é…ç½®SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        # éƒ¨ç½²åç«¯
        rsync -avz --delete ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/var/www/smart-community/api/
        
        # éƒ¨ç½²å‰ç«¯ç®¡ç†åå°
        rsync -avz --delete ./frontend-admin/dist/ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/var/www/smart-community/admin/
        
        # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²è„šæœ¬
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} 'cd /var/www/smart-community && ./deploy.sh'
    
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      uses: joelwmale/webhook-action@master
      with:
        url: ${{ secrets.WEBHOOK_URL }}
        body: '{"text": "ğŸš€ æ™ºæ…§ç¤¾åŒºå¹³å°å·²æˆåŠŸéƒ¨ç½²ï¼\n\næäº¤è€…: ${{ github.actor }}\næäº¤ä¿¡æ¯: ${{ github.event.commits[0].message }}\næŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}' 